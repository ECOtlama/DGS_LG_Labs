---
title: "R code for Week 3 Lab"
output: html_document
---
Week 3 Lab: Basic Population Genetic Analysis of Colombia Spotted Frog Data.

Authors: Lisette Waits, Helene Wagner, Melanie Murphy (R code by H. Wagner, Jan 2016)

### R code
This analysis uses functions from several R packages for genetic data analysis (gstudio, adegenet, pegas, hierfstat, PopGenReport). The R code is provided in a separate file. A similar report could be customized and generated semi-automatically with the function 'popgenreport' of the R package PopGenReport. Note that some of these R packages are currently under major development. This means that it is important to keep updating packages and that their dependencies can create problems. 

### Data files
The following files will be needed and should be located in the active R workspace.  

* RALU_loci_12pops.csv: File with populations and genetic data (preformatted for import, 181 rows x 9 columns)
* RALU_coords_12pops.csv: File with spatial coordinates for each population (12 rows x 4 columns).

Note: These data have been sorted alphabetically by site before import to ensure that genetic and spatial data will match.

### 1. Install and load R packages
* Remember to set your working directory to the folder with the data for this lab!
* Update R as needed
* Install or update packages from github (recommended due to frequent updates):
```{r}
# Install latest versions from github:
# ------------------------------------
# install.packages("devtools", repos = "http://cran.us.r-project.org")
# require(devtools)
# install_github("gstudio", "dyerlab", ref = "develop")
# install_github("green-striped-gecko/PopGenReport")
# install_github("thibautjombart/adegenet") # adegenet 2.0 had quite some bugs
# install_github("jgx65/hierfstat") #pairwise.fst no longer in adegenet
```

* Load packages (begin of each R session; if a package is missing, install it from CRAN):
```{r}
suppressPackageStartupMessages(library(adegenet))
suppressPackageStartupMessages(library(ade4))
suppressPackageStartupMessages(library(PopGenReport))
suppressPackageStartupMessages(library(pegas))
suppressPackageStartupMessages(library(gstudio))
suppressPackageStartupMessages(library(hierfstat))
suppressPackageStartupMessages(library(ggmap))
```

### 2. Import data

#### Import genetic data as a data.frame into gstudio, and as a 'genind' object for adegenet:
Note: This part can be tricky if your data set is formatted in a different way.
```{r}
  tmp <- read.csv("RALU_loci_12pops.csv", header=TRUE)    
  RALU.genind <- df2genind(tmp[,-1], pop = as.character(tmp[,1]), ind.names = c(1:nrow(tmp)), 
        NA.char = NA, sep = ":", ploidy = 2, type="codom")
  RALU.genind      
  
  RALU.gstudio <- read_population("RALU_loci_12pops.csv", type = "separated", locus.columns = 2:9)
  head(RALU.gstudio)
```

#### Import spatial data and add it to the 'genind' object in the slots provided
* other$latlong: coordinates in decimal lat/lon format
* other$xy: coordinates in UTM format
* other: may add attribute data, here: basin
```{r}
  XY <- read.csv("RALU_coords_12pops.csv", row.names=1)
  Basin <- c("Sheepeater", "Skyhigh", "Terrace", "Harbour", "Skyhigh", "Skyhigh", 
             "Skyhigh", "Birdbill", "TipTop", "Glacier", "Shipisland", "Skyhigh")

  # Add basin and spatial location information to genind object:
  RALU.genind$other$xy <- XY[,1:2]
  RALU.genind$other$latlong <- data.frame(Strata=unique(RALU.genind$pop),XY[,3:4])
  RALU.genind$other$basin <- Basin 
```

### 3. Create a Google map of sampling locations (gstudio, ggmap)
See gstudio vignette, or video tutorial by Rodney Dyer: 
http://dyerlab.bio.vcu.edu/2016/01/17/a-quick-ggmap-tutorial/
```{r}
  coords <- data.frame(Strata=RALU.genind$other$latlong$Strata,
                       Longitude=RALU.genind$other$latlong$Longitude,
                       Latitude=RALU.genind$other$latlong$Latitude,
                       Basin=RALU.genind$other$basin)
  map <- population_map(coords, map.source="google", zoom=12) 
  ggmap(map) + 
    geom_point(aes(x = Longitude, y = Latitude, color = Basin), 
               size = 10, data=coords) + 
    annotate("text", x=coords$Longitude, y=coords$Latitude, label = coords$Strata, 
             size=3, col="black")  
                        # In RMarkdown language, need to close plot window manually. 
  dev.off()             # Don't run this command if you are copy-pasting into R.
```  

### 4. Basic summary statistics (adegenet)
* Note: the formatting of this summary has changed from the printed output because the package 'adegenet' has been modified.
* Writing the summary into an object 'Sum' will allow us later on to access its attributes!
```{r}
  # Summarize data
  Sum <- summary(Frogs.genind)
  Sum
```  

```{r}
  # Summarize data
  tmp <- seppop(Frogs.genind)
  sapply(tmp, nInd)
  
  # To do: aggregate this by population!
  propTyped(Frogs.genind, by="ind")
  propTyped(Frogs.genind, by="loc")
  propTyped(Frogs.genind, by="both")
```  

```{r}
  # Summarize data
  Frogs.genpop <- genind2genpop(Frogs.genind)
  Freq <- makefreq(Frogs.genpop)
```  

```{r}
  # Genetic distances
  dist.genpop(Frogs.genpop, )

```  



### 5. Genetic diversity (gstudio, PopGenReport)
The package gstudio has a function 'genetic_diversity' that lets you specify a diversity measure (such as He) and a data set, and it will calculate the diversity measure for each locus in the data set. The code below calls this function several times, once per diversity measure, and extracts the column with the diversity values from each. It assembles these columns in a data frame 'Diversity.per.locus'.
```{r}
  args(genetic_diversity)        # Arguments of function; use '?genetic_diversity' for help file
  
  # Genetic diversity per locus:
  Diversity.per.locus <- data.frame(
    A=genetic_diversity(RALU.gstudio, mode="A")[,-1],
    Ae=genetic_diversity(RALU.gstudio, mode="Ae")[,-1],
    A95=genetic_diversity(RALU.gstudio, mode="Ae")[,-1],
    He=genetic_diversity(RALU.gstudio, mode="He")[,-1],
    Ho=genetic_diversity(RALU.gstudio, mode="Ho")[,-1],
    Fis=genetic_diversity(RALU.gstudio, mode="Fis")[,-1])
  row.names(Diversity.per.locus) <- genetic_diversity(RALU.gstudio, mode="A")[,1]
  round(Diversity.per.locus, 3)  # Genetic diversity by locus:
  
```  
More useful for interpretation would be a table by population:

* The code below splits the data set by population, then applies the 'genetic_diversity' function to each population, and assembles the results into a table of the chosen diversity measure by locus and population. 
* The package 'PopGenReport' provides a handy function 'allel.rich' to calculate allelic richness (rarefaction) across different levels of aggregation. It determines on its own to what number of samples the data should be resampled. The code below returns that number in a message.
* Finally, the code below calculates for each diversity measure either a sum (for number of alleles) or a mean across loci, and assembles these summary statistics in a table.
```{r}  
  # Per locus and population:
  pops <- partition(RALU.gstudio, stratum = "Pop")   # Split the data by population

  # Number of alleles A
  Table.A <- Reduce(rbind,lapply(pops, function(x) 
    genetic_diversity(x, mode="A")[,2]))
  dimnames(Table.A) <- list(names(pops), names(pops[[1]][-1]))
  Table.A <- data.frame(Table.A, Total=apply(Table.A, 1, sum))
  A.sum <- Table.A$Total
  
  # Effective number of alleles Ae
  Table.Ae <- Reduce(rbind,lapply(pops, function(x) 
    genetic_diversity(x, mode="Ae")[,2]))
  dimnames(Table.Ae) <- list(names(pops), names(pops[[1]][-1]))
  Table.Ae <- data.frame(Table.Ae, Total=apply(Table.Ae, 1, mean))
  Ae.mean <- Table.Ae$Total
  
  # Allelic richness (PopGenReport)
  tmp <- allel.rich(RALU.genind)
  Table.Ar <- data.frame(t(tmp$all.richness), Sum=tmp$sum.richness, 
                         Mean=tmp$mean.richness)
  cat("Number of alleles sampled for Ar: ", tmp$alleles.sampled, sep="")
  Ar.mean <- tmp$mean.richness
  
  # Expected heterozygosity
  Table.He <- Reduce(rbind,lapply(pops, 
                function(x) genetic_diversity(x, mode="He")[,2]))
  dimnames(Table.He) <- list(names(pops), names(pops[[1]][-1]))
  He.mean <- apply(Table.He, 1, mean)
  
  # Observed heterozygosity
  Table.Ho <- Reduce(rbind,lapply(pops, 
                function(x) genetic_diversity(x, mode="Ho")[,2]))
  dimnames(Table.Ho) <- list(names(pops), names(pops[[1]][-1]))
  Ho.mean <- apply(Table.Ho, 1, mean)
  
  # Sort populations from North to South, print summary of genetic diversity
  a3 <- order(RALU.genind$other$latlong$Latitude, decreasing=TRUE)  
  data.frame(Basin=RALU.genind$other$basin,
    round(data.frame(A.sum, Ar.mean, He.mean, Ho.mean),3))[a3,]
```  

#### Plot number of alleles and allelic richness against sample size
```{r, fig.width=7, fig.height=4}
  par(mfrow=c(1,2), omi=c(0,0,0,0), mai=c(0.8,0.8,0.8,0.2))
    # Plot number of alleles against sample size per population
  plot(Sum$n.by.pop, Sum$pop.n.all, xlim=c(5,30), ylim=c(12,28),
       xlab="Sample size per location", ylab="Number of alleles",
       main="Number of alleles vs. sample size", cex.main=0.8)
  text(Sum$n.by.pop, Sum$pop.n.all, labels=names(Sum$n.by.pop), pos=4, cex=0.6)
  abline(lm(Sum$pop.n.all ~ Sum$n.by.pop), col="red")
  

  # Plot allelic richness against sample size per population
  plot(Sum$n.by.pop, tmp$mean.richness, xlim=c(5,30), ylim=c(1,3),
       xlab="Sample size per location", ylab="Allelic richness",
       main="Allelic richness vs. sample size", cex.main=0.8)
  text(Sum$n.by.pop, tmp$mean.richness, labels=names(Sum$n.by.pop), pos=4, cex=0.6)
  abline(lm(tmp$mean.richness ~ Sum$n.by.pop), col="red")
                        # In RMarkdown language, need to close plot window manually. 
  dev.off()             # Don't run this command if you are copy-pasting into R.
```  
  
### 6. Test for Hardy-Weinberg Equilibrium (pegas) 
* Note: adegenet had a similar function 'HWE.test.genind' for testing HWE that is now disfunct (this may create problems e.g. when running 'popgenreport'). Instead, use function 'hw.test' from package 'pegas'.
* The code below converts the 'genind' object into a 'loci' object and tests each locus for deviation from HWE.
* It then splits thee data by population and repeats the analysis, extracting the p-values.
* It then aggregates the p-values into a table with populations sorted from North to South.
```{r}
  round(hw.test(as.loci(RALU.genind)),3)  # Test for HWE by locus:
  
  # Test for HWE by population and locus (values are p-values):
  test <- by(as.loci(RALU.genind), RALU.genind$pop, hw.test)  
  Table.HWE <- Reduce(rbind, lapply(test, function(x) x[,4]))
  dimnames(Table.HWE) <- list(names(test), row.names(test[[1]]))
  a3 <- order(RALU.genind$other$latlong$Latitude, decreasing=TRUE)
  data.frame(Basin=RALU.genind$other$basin, Table.HWE)[a3,]
```      

### 7. Population genetic structure (hierfstat, pegas)
```{r}
# Note: both 'pegas' and 'gstudio' have a function 'Fst', hence call to pegas::Fst()
  
  pegas::Fst(as.loci(RALU.genind))                  # Fst for each locus
  fstat(RALU.genind)                                # Global F statistics across loci
  
  # Pairwise Fst
  Table.pwFst <-pairwise.fst(RALU.genind, res.type="matrix")
  a3 <- order(RALU.genind$other$latlong$Latitude, decreasing=TRUE)
  data.frame(Basin=RALU.genind$other$basin[a3],
             round(Table.pwFst[a3,a3],3))   
  
```      

### 8. Test for Isolation by Distance (adegenet)
```{r}
RALU.genpop <- genind2genpop(RALU.genind, quiet=TRUE)
  Dgen <- dist.genpop(RALU.genpop,method=1)
  Dgeo <- dist(RALU.genind$other$xy)
  plot(Dgeo, Dgen, xlab="Geographic Distance", ylab="Genetic Distance (Nei)")
  IBD <- mantel.randtest(Dgen,Dgeo)
  IBD
  
```      

  