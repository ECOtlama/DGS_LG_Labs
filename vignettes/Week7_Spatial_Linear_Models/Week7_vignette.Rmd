---
title: "Week 7: Spatial Linear Models"
author: "Helene Wagner"
date: "`r Sys.Date()`"
show_toc: true
output:
  knitr:::html_vignette:
    toc: yes
    fig_width: 4 
    fig_height: 3.5
vignette: >
  %\VignetteIndexEntry{Week 7: Spatial Linear Models}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
## 1. Overview of Worked Example

### a) Goals 

This worked example shows:

- How to test regression residuals for spatial autocorrelation.
- How to fit a model with spatially autocorrelated errors (GLS)
- How to derive Moran Eigenvector Maps from sampling locations
- How to perform spatial filtering with MEM
- How to do the analogue of a partial Mantel test with 'Sunder'

### b) Data set

Here we analyze population-level data for 29 ponds from the Columbia spotted frog data (Murphy et al. 2010). 

NOTE: IMPORT DATA, ADD DESCRIPTION
- **ralu.loci**: Data frame with populations and genetic data (181 rows x 9 columns). Included in package 'LandGenCourse'. To load it, type: data(ralu.loci)

### c) Required R libraries

All required packages should have been installed already when you installed 'LandGenCourse'.

Note: the function 'library' will always load the package, even if it is already loaded, whereas 'require' will only load it if it is not yet loaded. Either will work.

```{r message=FALSE, warning=TRUE}
#require(adegenet)
#require(gstudio)
require(LandGenCourse)
#require(tibble)
#require(here)
```

## 2. Non-linear regression model (LM)

### a) Import data

```{r}
#Frogs.site <- read.csv("./data/RALU_data_div.csv", header=TRUE)

data(ralu.site, package="GeNetIt")
Frogs.site <- data.frame(ralu.site@coords, ralu.site@data)
tibble::as.tibble(Frogs.site)

SiteName <- c(Frogs.site$SiteName[c(1:3, 5:28)], NA, Frogs.site$SiteName[30:31])

ralu.loci <- read.csv(paste0(here::here(), "/vignettes/Week7_Spatial_Linear_Models/RALU_loci_allpops.csv"))

#Frogs <- data.frame(FrogID = paste(substr(ralu.loci$Pop, 1, 3),row.names(ralu.loci), sep="."),
#                    ralu.loci)
Frogs <- data.frame(ralu.loci)
Frogs$Pop <- as.character(Frogs$Pop)
Frogs$Pop[Frogs$Pop =="Doe  "] <- "Doe"
Frogs$Pop[Frogs$Pop =="GentainL"] <- "GentianL"
Frogs$Pop[Frogs$Pop =="GentainP"] <- "GentianP"
Frogs$Pop <- factor(Frogs$Pop)

Frogs$E <- as.character(Frogs$E)
Frogs$E[Frogs$E == "10:10"] <- "9:9"
Frogs$E <- factor(Frogs$E)

#Frogs$SiteName <- SiteName[as.numeric(Frogs$Pop)]
Frogs <- data.frame(SiteName = SiteName[as.numeric(Frogs$Pop)], Frogs)
  
Frogs.genind <- adegenet::df2genind(X=Frogs[,c(3:10)], sep=":", ncode=NULL, 
                                    ind.names= NULL, loc.names=NULL, 
                                    pop=Frogs$Pop, NA.char="NA", ploidy=2, 
                                    type="codom", strata=NULL, hierarchy=NULL)
Frogs.genind
Frogs.ecogen <- EcoGenetics::genind2ecogen(Frogs.genind)
row.names(Frogs) <- row.names(Frogs.ecogen@G)
Frogs.ecogen[["S"]] <- data.frame(Frogs[,1:2])

RA <- PopGenReport::allel.rich(Frogs.genind)$mean.richness



Frogs.ecopop <- EcoGenetics::ecogen2ecopop(Frogs.ecogen, hier="Pop") 

tmp <- data.frame(SiteName)
row.names(tmp) <- row.names(Frogs.ecopop[["S"]])
Frogs.ecopop[["C"]] <- data.frame(SiteName=tmp, RA=RA)

tmp <- ralu.site
tmp[29,] <- NA
tmp <- tmp[-4,]
dim(tmp)
row.names(tmp) <- row.names(Frogs.ecopop[["C"]])
tmp@coords[28,] <- NA
Frogs.ecopop[["E"]] <- tmp@data
Frogs.ecopop[["XY"]] <- tmp@coords
```

### b) Least squares regression model (LM)


```{r}
mod.lm <- lm(Frogs.ecopop[["C"]]$RA ~ AREA_m2 + Depth_m + TDS, data = Frogs.ecopop[["E"]])
mod.lm
```

### b) Alternative data set: WWP


```{r}
data(WWP.ecogen, package="LandGenCourse")

cor(WWP.ecogen[["P"]]$prov.eff, WWP.ecogen[["E"]])

# Combined reconstructed trait (by family):
cor(apply(WWP.ecogen[["P"]],1,sum), WWP.ecogen[["E"]])
```

# Estimate plot effect? Not better!
```{r}
phen <- read.delim(system.file("extdata", "WWP_phenotype_data.txt", 
                            package = "LandGenCourse"), sep = "\t", header = T)
phen$family <- as.factor(phen$family)
phen$block <- as.factor(phen$block)
mod5 <- lme4::lmer(d13c ~ 1 + (1|plot/family) + block, 
                   data = phen, REML = TRUE)
plot.eff <- lme4::ranef(mod5)$plot


WWP.ecogen@S$plot <- factor(WWP.ecogen@S$plot)
WWP.ecopop <- EcoGenetics::ecogen2ecopop(WWP.ecogen, hier="plot")
WWP.ecopop[["E"]] <- aue.aggregated_df(WWP.ecogen@E, WWP.ecogen@S$plot, 
                     fun=function(x) mean(x, na.rm = TRUE), 
                     factor_to_counts = TRUE)

cor(plot.eff, WWP.ecopop[["E"]])
```

```{r}
Trait <- apply(WWP.ecogen[["P"]],1,sum)
cor(Trait, WWP.ecogen[["E"]])
mod.lm <- lm(Trait ~ ., data = WWP.ecogen[["E"]])
mod.lm.XY <- lm(Trait ~ ., data = cbind(WWP.ecogen[["E"]], WWP.ecogen@XY[,3:4]))
summary(mod.lm)
car::vif(mod.lm)
```

```{r}
WWP.ecogen@XY <- cbind(WWP.ecogen@XY[,1:2], SoDA::geoXY(WWP.ecogen@XY$latitude, 
                  WWP.ecogen@XY$longitude))
plot(WWP.ecogen@XY$X, WWP.ecogen@XY$Y, asp=1)
#adegenet::chooseCN(xy=WWP.ecogen@XY[,c("X", "Y")], )
nb.gab <- spdep::graph2nb(spdep::gabrielneigh(coords=
                          data.matrix(WWP.ecogen@XY[,c("X", "Y")]), nnmult=6), 
                          sym=TRUE)
listw.gab <- spdep::nb2listw(nb.gab)
spdep::moran.test(Trait, listw.gab)             # Y
spdep::lm.morantest(mod.lm, listw.gab)          # residuals
spdep::lm.morantest(mod.lm.XY, listw.gab)       # residuals|(XY)

# Strong autocorrelation in environmental data:
t(rbind(sapply(WWP.ecogen@E, function(ls) spdep::moran.test(ls, listw.gab)$estimate),
p.value = sapply(WWP.ecogen@E, function(ls) spdep::moran.test(ls, listw.gab)$p.value)))
```



```{r message=FALSE, warning=TRUE, include=FALSE}
LandGenCourse::detachAllPackages()
```
