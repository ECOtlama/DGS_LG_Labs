---
title: "Solutions to R Exercises (Weeks 1 - 8)"
author: "Helene Wagner"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: true
      smooth_scroll: true
---

# Week 1 

### a) Load packages

```{r}
library(gstudio)
library(tibble)
library(adegenet)
library(here)
```

### b) View data file

```{r}
# Copy to downloads folder (as needed):
file.copy(system.file("extdata", "pulsatilla_genotypes.csv", package = "LandGenCourse"),
          paste0(here(), "/downloads/pulsatilla_genotypes.csv"), overwrite=FALSE)

# Import from downloads folder:
Pulsatilla <- read.csv(paste0(here(), "/downloads/pulsatilla_genotypes.csv"), header=TRUE)
#View(Pulsatilla)
```

### c) Import data into `gstudio`

Notes: 

- Need to load library `gstudio` or use `gstudio::read_population`
- Argument `type` should be set to 'column'.
- Specify correct columns for locus data

```{r}
Pulsatilla.gstudio <- read_population(path=system.file("extdata",
                           "pulsatilla_genotypes.csv", 
                           package = "LandGenCourse"), 
                   type="column", locus.columns=c(6:19), 
                   phased=FALSE, sep=",", header=TRUE)
```

### d) Check imported data

Note: `str` may create an error message "Error: $ operator is invalid for atomic vectors" - there seems to be some interference with other packages, depending on what files are open. It seems to run without error during `knit`, though. May use `as_tibble` instead.

```{r}
#str(Pulsatilla.gstudio)
# Alternative
as_tibble(Pulsatilla.gstudio) 
```

### e) Check variable types

Note: to create bulleted list, there must be an empty line before the list and one after the list.

- **ID**: integer
- **OffID**: integer
- **Population**: character
- **Coordinates**: numeric (`dbl` means numeric with double precision)
- **Loci**: locus (secondary type: character) 

### f) Convert to genind object

```{r}
Pulsatilla.genind2 <- adegenet::df2genind(X=Pulsatilla.gstudio[,c(6:12)], sep=":", ncode=NULL,   
                          ind.names=Pulsatilla.gstudio$ID, loc.names=NULL, 
                          pop=Pulsatilla.gstudio$Population, NA.char="", ploidy=2, 
                          type="codom", strata=NULL, hierarchy=NULL)
Pulsatilla.genind2
```
Note: the last row in the output ("Optional content") should list @pop and indicate that group size ranges between 55 - 128 genotyped individuals. 

### Answer

There are between 55 - 128 genotyped individuals per site ("group"). 



# Week 2 

### a) Load packages

```{r}
library(gstudio)
library(dplyr)
library(tibble)
library(sp)
```

### b) Import data

```{r}
Pulsatilla.gstudio <- read_population(path=system.file("extdata",
                           "pulsatilla_genotypes.csv", 
                           package = "LandGenCourse"), 
                   type="column", locus.columns=c(6:19), 
                   phased=FALSE, sep=",", header=TRUE)
#str(Pulsatilla.gstudio)
as_tibble(Pulsatilla.gstudio)
```

### c) Summarize by site

```{r}
Pulsatilla <- Pulsatilla.gstudio %>% group_by(Population) %>% summarize(nIndiv = n())
```

### d) Add mean coordinates

Note: important to specify site indicator `Population`.

```{r}
Pulsatilla <- Pulsatilla.gstudio %>% group_by(Population) %>% summarize(nIndiv = n(), meanX = mean(X), meanY = mean(Y))
```
 
### e) Convert to spatial object

Note: important to use the variable names created above in d.

```{r}
coordinates(Pulsatilla) <- ~ meanX + meanY
```

### f) Specify known projection
 
```{r}
proj4string(Pulsatilla) <- CRS("+init=epsg:31468")
```

### g) Transform projection

```{r}
Pulsatilla.longlat <- sp::spTransform(Pulsatilla, 
                      CRSobj = tmaptools::get_proj4("longlat")$proj4string)
Pulsatilla.longlat@coords
```

### h) Create bubble plot

Note: important to use the variable name created above in c/d.
```{r}
bubble(Pulsatilla.longlat, "nIndiv", fill = FALSE)
```

### i) Save R object

```{r}
saveRDS(Pulsatilla.longlat, file = paste0(here::here(), "/output/Pulsatilla.longlat.rds"))
```

### Answer

The sites are located in Southern Germany. To check, enter the following in Google maps: 
`48.99875, 11.06123` and zoom out. 

Note: must specify latitude first, then longitude. Must use coordinates in "lonlat" projection.

# Week 3 

### a) Load packages

```{r}
library(gstudio)
library(dplyr)
library(adegenet)
```

### b) Import data

```{r}
library(gstudio)
Pulsatilla.gstudio <- read_population(path=system.file("extdata",
                           "pulsatilla_genotypes.csv", 
                           package = "LandGenCourse"), 
                   type="column", locus.columns=c(6:19), 
                   phased=FALSE, sep=",", header=TRUE)
```

### c) Count individuals

```{r}
# Overall sample size:
nrow(Pulsatilla.gstudio)

# Number of adults:
nrow(Pulsatilla.gstudio[Pulsatilla.gstudio$OffID == 0,])

# Alternative with 'filter':
Pulsatilla.gstudio %>% filter(OffID == 0) %>% nrow()
```

### d) Drop offspring 

```{r}
# By indexing:
Pulsatilla.adults <- Pulsatilla.gstudio[Pulsatilla.gstudio$OffID == 0,]
nrow(Pulsatilla.adults)

# Alternative with 'filter':
Pulsatilla.adults <- Pulsatilla.gstudio %>% filter(OffID == 0)
nrow(Pulsatilla.adults)
```

### e) Split dataset by site

```{r}
Adults.by.site <- split(Pulsatilla.adults, Pulsatilla.adults$Population)
length(Adults.by.site)
```

### f) Count adults per site 

```{r}
sapply(Adults.by.site, nrow)
```

### g) Convert to genind object

```{r}
Adults.genind <- adegenet::df2genind(X=Pulsatilla.adults[,c(6:12)], sep=":", ncode=NULL, 
                          ind.names= Pulsatilla.adults$ID, loc.names=NULL, 
                          pop=Pulsatilla.adults$Population, NA.char="", ploidy=2, 
                          type="codom", strata=NULL, hierarchy=NULL)

Adults.genind
```

### h) Check polymorphism

```{r}
summary(Adults.genind)
```

### i) Test HWE by site & locus

Note: while a few values are <0.05, there is not systematic pattern, i.e. no locus seems to be out of HWE across many site, and vice versa.

```{r}
# Chi-squared test: p-value
HWE.test <- data.frame(sapply(seppop(Adults.genind), 
                              function(ls) pegas::hw.test(ls, B=0)[,3]))
HWE.test.chisq <- t(data.matrix(HWE.test))
{cat("Chi-squared test (p-values):", "\n")
round(HWE.test.chisq,3)}
```

### k) Calculate Hexp, Hobs by site

```{r}
Hexp <- t(sapply(seppop(Adults.genind), function(ls) summary(ls)$Hexp))
Hobs <- t(sapply(seppop(Adults.genind), function(ls) summary(ls)$Hobs))
Hexp.pop <- apply(Hexp, 1, mean)
Hobs.pop <- apply(Hobs, 1, mean)

H.pop <- data.frame(Pop = names(Hobs.pop),
                              Hobs = Hobs.pop,
                              Hexp = Hexp.pop)
H.pop
```

### l) Save results as R object

```{r}
saveRDS(H.pop, file = paste0(here::here(), "/output/H.pop.rds"))
```

### Answer

Site G05a had the lowest expected heterozygosity.


# Week 4 


### a) Load packages

```{r}
library(dplyr)
library(ggplot2)
```

### b) Import saved objects 

```{r}
Pulsatilla.longlat <- readRDS(paste0(here::here(), "/output/Pulsatilla.longlat.rds"))
H.pop <- readRDS(paste0(here::here(), "/output/H.pop.rds"))
```

### c) Plot sites on map

Plot the residuals on top of the map 'myMap':

Basic map with points:

```{r}
myMap <- ggmap::qmplot(meanX, meanY,  data = as.data.frame(Pulsatilla.longlat), 
                       source = "stamen", maptype = "toner-lite")
```

Modify code from 3.c to add labels and plot the map:

```{r fig.height=5, fig.width=7, message=FALSE}
myMap + ggplot2::geom_label(data = as.data.frame(Pulsatilla.longlat),
                   mapping = ggplot2::aes(meanX, meanY, label = Population),
                   size = 2.5, label.padding = unit(0.12, "lines"),
                   col = "black", vjust = 0, nudge_x = 0, nudge_y = -0.005)
```

### d) Combine data

Note: it is important here to work with the @data slot: Pulsatilla.longlat@data.

Check structure of datasets (could also use `head` or `tibble::as_tibble` or simply print them).

```{r}
str(Pulsatilla.longlat@data)
```
```{r}
str(H.pop)
```

Change variable type from factor to character: 

```{r}
H.pop$Pop <- as.character(H.pop$Pop)
```

Add data from `H.pop` to `Pulsatilla.longlat@data`. Here it is important to indicate the ID variable names ("Population" and "Pop") correctly, and to use the @data slot. 

```{r}
Pulsatilla.longlat@data <- dplyr::left_join(Pulsatilla.longlat@data, H.pop, by=c("Population" = "Pop"))
```

Note: if the variable types are not the same for the two ID variables, you'll get a warning: "Column `Population`/`Pop` joining character vector and factor, coercing into character vector". This is only a warning, not an error message, hence R will still perform the join. 

### e) Scatterplot with line

Either with base R...

```{r}
plot(Hexp ~ nIndiv, data=Pulsatilla.longlat, xlim=c(50, 130))
abline(lm(Hexp ~ nIndiv, data=Pulsatilla.longlat))
text(Pulsatilla.longlat@data$nIndiv, Pulsatilla.longlat@data$Hexp,
     labels=Pulsatilla.longlat@data$Population, cex= 0.8, pos=4)
```

Or with ggplot:

```{r}
ggplot(Pulsatilla.longlat@data, aes(x=nIndiv, y=Hexp, label=Population)) + 
  geom_point() + 
  geom_smooth(method = lm, se = TRUE) +
  geom_text(nudge_y=0.012, size=4, check_overlap=TRUE)
```

### f) Regression analysis

Fit the model. 

Note: here you can use either `data=Pulsatilla.longlat` or `data=Pulsatilla.longlat@data`.

```{r}
mod <- lm(Hexp ~ nIndiv, data=Pulsatilla.longlat)
summary(mod)
```

The slope is not significant. Is the model valid? Checking residual plots:

```{r fig.height=7, fig.width=8}
par(mfrow=c(2,2))
plot(mod, labels.id = Pulsatilla.longlat@data$Population)
par(mfrow=c(1,1))
```

### Answers

There is one influential point in the regression analysis:

- Which site is it? - Site A25. 
- Where is it located (north / east / south / west)? - In the (South-)West.
- What makes it an influential point (large residual, leverage, or both)? - Leverage (outlier along x: very large census population size 'nIndiv')
- What would happen to the regression line and the R-squared if this point was omitted? - The line would become much steeper, and the Rsquared would be much smaller. 


# Week 5 

a) **Load packages**: You may want to load the packages `dplyr`, `EcoGenetics` and `adegenet`. Alternatively, you can use `::` to call functions from packages.

### a) Load packages

```{r}
library(adegenet)
library(dplyr)
library(EcoGenetics)
```

### b) Import data, extract A25 adults

```{r}
Pulsatilla.gstudio <- gstudio::read_population(path=system.file("extdata",
                            "pulsatilla_genotypes.csv", 
                            package = "LandGenCourse"), 
                    type="column", locus.columns=c(6:19), 
                    phased=FALSE, sep=",", header=TRUE)

```

Inspect a few rows:

```{r}
as_tibble(Pulsatilla.gstudio)
```

Filter adults (OffID == 0) to drop seeds, filter site A03:

```{r}
Adults.A25.gstudio <- Pulsatilla.gstudio %>% filter(OffID == 0, Population == "A25")
```

### c) Plot locations of individuals 

```{r}
plot(Adults.A25.gstudio$X, Adults.A25.gstudio$Y, asp=1)
```

### d) Convert to ecogen and genind

Convert to `ecogen`:

```{r}
Adults.A25.ecogen <- EcoGenetics::gstudio2ecogen(Adults.A25.gstudio, ID = "ID", 
                            lat = "X", lon = "Y")
```

Convert from `ecogen` to `genind`:

```{r}
Adults.A25.genind <- EcoGenetics::ecogen2genind(Adults.A25.ecogen)
```
  
### e) Calculate genetic and Euclidean distances

- Use individual-level function `propShared` for a `genind` object. 
- Subtract from 1 to convert to distance measure.
- Check class and convert to `dist` object.

```{r}
Dgen <- 1 - adegenet::propShared(Adults.A25.genind)
class(Dgen)
Dgen <- as.dist(Dgen)
class(Dgen)
```

Calculate Euclidean distance from coordinates:

```{r}
Dgeo <- dist(EcoGenetics::ecoslot.XY(Adults.A25.ecogen))
```

### f) Mantel test

```{r}
par(mar=c(4,4,0,0))
dens <- MASS::kde2d(as.vector(Dgeo), as.vector(Dgen), n=300)
myPal <- colorRampPalette(c("white","blue","gold","orange","red"))
plot(Dgeo, Dgen, pch=20, cex=0.5,  
    xlab="Geographic Distance", ylab="Genetic Distance")
image(dens, col=transp(myPal(300), 0.7), add=TRUE)
abline(lm(Dgen ~ Dgeo))
lines(loess.smooth(Dgeo, Dgen), col="red")
```

Test for IBD with Mantel rank correlation

```{r}
IBD <- vegan::mantel(Dgen,Dgeo, method="spearman")
IBD
```

### g) Mantel correlogram

```{r}
corm <- EcoGenetics::eco.cormantel(M = Dgen, 
        XY = ecoslot.XY(Adults.A25.ecogen),  nsim = 199, latlon=FALSE, 
        alternative="less", method = "pearson", sequential=TRUE)
corm
```

### Answers 

What is the range of spatial autocorrelation in *P. vulgaris* in site A25?

- Based on a plot of genetic distance against Euclidean distance: about 15 m
- Based on where the Mantel correlogram reaches 0: < 10 m 
- Based on statistical significance tests for the Mantel correlogram: about 8.3 m


# Week 6 


### a) Load packages

```{r}
install.packages("inbreedR")
library(inbreedR)
library(dplyr)
library(ggplot2)
```

### b) Import data and extract adults
```{r}
Pulsatilla.all <- read.csv(system.file("extdata", "pulsatilla_genotypes.csv", 
                            package = "LandGenCourse"))
Adults <- Pulsatilla.all %>% filter(OffID == 0)
```

### c) Calculate multilocus heterzygosity

Here, we're dropping the first five columns because they contain non-genetic data.

```{r}
genotypes <- inbreedR::convert_raw(Adults[,-c(1:5)])
Adults$het <- inbreedR::MLH(genotypes)
```

### d) Add population-level data

```{r}
Pop.data <- read.csv(system.file("extdata", "pulsatilla_population.csv", 
                            package = "LandGenCourse"))
Adults <- dplyr::left_join(Adults, Pop.data)
tibble::as_tibble(Adults)
```

### e) Scatterplot with regression line

```{r}
ggplot(Adults, aes(population.size, het)) + geom_point() +
  geom_smooth(method="lm")
```

### f) Fit linear mixed model

```{r}
mod <- lme4::lmer(het ~ population.size + (1|Population) , 
                   data = Adults, REML = TRUE)
summary(mod)
```

### g) Test fixed effect

```{r}
mod.ML <- lme4::lmer(het ~ population.size + (1|Population) , 
                   data = Adults, REML = FALSE)
car::Anova(mod.ML, type="II", test.statistic="Chisq")
```

### h) Check residual plots

```{r}
predictmeans::residplot(mod, group="Population", level=1)
```

### Answers

Conclusions from fitting the LMM:

- What was the direction of the relationship, did heterozygosity increase or decrease with census population size? - Heterozygosity decreased with census population size, which might be unexpected.
- Was the fixed effect statistically significant? If not, do you think that statistical power was sufficient?- No, the p-value was > 0.05. However, there were only seven populations, and the predictor was measured at the population level.
- Was the model valid, or was there a problem with the residual plots? - Yes, there was a problem with the residuals. 
- What would be the main issue, and what remedy could you suggest? - Residuals were not normally distributed. The response behaves like a proportion, hence fitting a generalized model with family = "binomial" might help.


# Week 7 

# Week 8 